var webPageCanvas;class WebPageCanvas{constructor(){this.activeToolInfo={id:"paintBrush",htmlID:"paint-brush",options:{color:"#FFFF00",size:5}},this.canvas={clickX:[],clickY:[],clickDrag:[],clickTool:[],clickColor:[],clickSize:[],isDrawing:!1,element:null,context:null},this.hasDrawings=!1,this.windowHeight=0,this.windowScroll=0}init(){this.initCanvas(),window.onresize=this.adjustCanvas.bind(this),this.attachHandlers(),this.adjustCanvas()}attachHandlers(){for(let t of document.querySelectorAll(".tool-container, .option-container"))t.addEventListener("click",this.onToolClickHandler.bind(this,t));for(let t of document.querySelectorAll("span.color[data-color-code]"))t.addEventListener("click",this.colorClickHandler.bind(this,t));for(let t of document.querySelectorAll("#toolbar-alignment .dropdown-item"))t.addEventListener("click",this.alignClickHandler.bind(this,t));for(let t of document.querySelectorAll(".dropdown input[type='range']"))t.addEventListener("change",this.sizeChangeHandler.bind(this,t));document.querySelector(".option-container[title='Clear All']").addEventListener("click",this.canvas.context.clearAll.bind(this)),document.getElementById("close-toolbar").addEventListener("click",this.destroy.bind(this))}onToolClickHandler(t,e){if(t.dataset.hasDropdown)Array.from(t.children).forEach(function(a){if(a.classList.contains("dropdown")&&a.classList.contains("hidden")){let t=document.querySelector(".dropdown:not(.hidden)");null!=t&&t.classList.add("hidden"),a.classList.remove("hidden"),this.canvas.element.addEventListener("click",function(){a.classList.add("hidden")}.bind(this,a),{once:!0})}else!a.classList.contains("dropdown")||a.classList.contains("hidden")||0!=e.path.indexOf(t)&&1!=e.path.indexOf(t)||a.classList.add("hidden")}.bind(this));else{let t=document.querySelector(".dropdown:not(.hidden)");null!=t&&t.classList.add("hidden")}if(this.resetCanvasTools(),t.classList.contains("tool-container")&&!t.classList.contains("active")){let e=document.querySelector(".tool-container.active");null!=e&&e.classList.remove("active"),t.classList.add("active");let a=".tool-container[title='"+t.title+"']";"Paint Brush"==t.title?(this.activeToolInfo.id="paintBrush",this.activeToolInfo.htmlID="paint-brush",this.sizeChangeHandler.call(this,document.querySelector(a+" input[type='range']")),this.activeToolInfo.options.color=document.querySelector(a+" span.color.active").dataset.colorCode):"Eraser"==t.title?(this.activeToolInfo.id=this.activeToolInfo.htmlID="eraser",this.sizeChangeHandler.call(this,document.querySelector(a+" input[type='range']"))):"Highlighter"==t.title&&(this.activeToolInfo.id=this.activeToolInfo.htmlID="highlighter",this.sizeChangeHandler.call(this,document.querySelector(a+" input[type='range']")),this.activeToolInfo.options.color=document.querySelector(a+" span.color.active").dataset.colorCode)}}alignClickHandler(t){let e=document.getElementById("toolbar");t.classList.contains("top")?(e.classList.remove("aligned-bottom"),e.classList.add("aligned-top"),e.style.top=this.windowScroll+"px"):t.classList.contains("bottom")&&(e.classList.remove("aligned-top"),e.classList.add("aligned-bottom"),e.style.top=this.windowScroll+this.windowHeight-e.offsetHeight+"px")}sizeChangeHandler(t){"paint-brush"==t.dataset.tool?t.nextElementSibling.innerText=t.value:"eraser"==t.dataset.tool&&(t.nextElementSibling.innerText=t.value),this.activeToolInfo.options.size=parseInt(t.value)}colorClickHandler(t){let e=t.parentElement.parentElement.parentElement.title,a=".tool-container[title='"+e+"']";if(!t.classList.contains("active")){document.querySelector(a+" span.color.active[data-color-code]").classList.remove("active"),t.classList.add("active");let s,i=t.dataset.colorCode;if("Paint Brush"==e)s=document.querySelector(".icon-paint-brush");else if("Highlighter"==e)s=document.querySelector(".icon-highlighter");else if("Paint Brush"!=e&&"Highlighter"!=e||!i)return;"Black"==t.title?(s.classList.add("black"),s.classList.remove("green"),s.classList.remove("purple"),s.classList.remove("brown")):"Green"==t.title?(s.classList.add("green"),s.classList.remove("black"),s.classList.remove("purple"),s.classList.remove("brown")):"Purple"==t.title?(s.classList.add("purple"),s.classList.remove("black"),s.classList.remove("green"),s.classList.remove("brown")):"Brown"==t.title?(s.classList.add("brown"),s.classList.remove("black"),s.classList.remove("green"),s.classList.remove("purple")):(s.style.color=t.dataset.colorCode,s.classList.remove("black"),s.classList.remove("green"),s.classList.remove("purple"),s.classList.remove("brown")),this.activeToolInfo.options.color=i}}destroy(){this.hasDrawings?chrome.runtime.sendMessage({message:"close-canvas",data:this.canvas.element.toDataURL()}):chrome.runtime.sendMessage({message:"close-canvas"})}initCanvas(){this.canvas.element=document.querySelector("canvas"),this.canvas.context=this.canvas.element.getContext("2d"),this.canvas.context.fillCircle=function(t,e,a,s){this.fillStyle=s,this.beginPath(),this.moveTo(t,e),this.arc(t,e,a,0,2*Math.PI,!1),this.fill()},this.canvas.context.clearAll=function(){this.hasDrawings=!1,this.canvas.context.clearRect(0,0,this.canvas.element.width,this.canvas.element.height)}.bind(this),this.canvas.element.onmousemove=function(t){this.canvas.isDrawing&&("paintBrush"==this.activeToolInfo.id||"highlighter"==this.activeToolInfo.id?(this.addClick(t.offsetX,t.offsetY,!0,this.activeToolInfo.id,this.activeToolInfo.options.size,this.activeToolInfo.options.color),this.draw()):"eraser"==this.activeToolInfo.id&&(this.addClick(t.offsetX,t.offsetY,!0,this.activeToolInfo.id,this.activeToolInfo.options.size,!1,!1),this.erase()))}.bind(this),this.canvas.element.onmousedown=function(t){this.canvas.isDrawing=!0,"paintBrush"==this.activeToolInfo.id||"highlighter"==this.activeToolInfo.id?this.addClick(t.offsetX,t.offsetY,!0,this.activeToolInfo.id,this.activeToolInfo.options.size,this.activeToolInfo.options.color):"eraser"==this.activeToolInfo.id&&this.addClick(t.offsetX,t.offsetY,!0,this.activeToolInfo.id,this.activeToolInfo.options.size,!1)}.bind(this),this.canvas.element.onmouseup=function(){this.canvas.isDrawing=!1,this.resetCanvasTools()}.bind(this),this.canvas.element.onmouseleave=function(){this.canvas.isDrawing=!1}.bind(this)}resetCanvasTools(){this.canvas.clickX=[],this.canvas.clickY=[],this.canvas.clickDrag=[],this.canvas.clickSize=[],this.canvas.clickColor=[],this.canvas.clickTool=[]}addClick(t,e,a,s,i,n){this.canvas.clickX.push(t),this.canvas.clickY.push(e),this.canvas.clickDrag.push(a),this.canvas.clickTool.push(s),this.canvas.clickSize.push(i),n&&this.canvas.clickColor.push(n)}draw(){this.hasDrawings||(this.hasDrawings=!0);for(let t=0;t<this.canvas.clickX.length;t++)"highlighter"==this.canvas.clickTool[t]?(this.canvas.context.globalAlpha=.4,this.canvas.context.lineJoin="mitter"):(this.canvas.context.globalAlpha=1,this.canvas.context.lineJoin="round"),this.canvas.context.beginPath(),this.canvas.clickDrag[t]&&t?("highlighter"==this.canvas.clickTool[t-1]&&this.canvas.clickX.indexOf(this.canvas.clickX[t-1])==t-1&&this.canvas.clickY.indexOf(this.canvas.clickY[t-1]),this.canvas.context.moveTo(this.canvas.clickX[t-1],this.canvas.clickY[t-1]),this.canvas.clickX.splice(t-1,1),this.canvas.clickY.splice(t-1,1)):("highlighter"==this.canvas.clickTool[t]&&this.canvas.clickX.indexOf(this.canvas.clickX[t])==t&&this.canvas.clickY.indexOf(this.canvas.clickY[t]),this.canvas.context.moveTo(this.canvas.clickX[t]-1,this.canvas.clickY[t]),this.canvas.clickX.splice(t,1),this.canvas.clickY.splice(t,1)),this.canvas.context.lineTo(this.canvas.clickX[t],this.canvas.clickY[t]),this.canvas.context.closePath(),this.canvas.context.lineWidth=this.canvas.clickSize[t],"eraser"!=this.canvas.clickTool[t]&&this.canvas.clickColor[t]&&(this.canvas.context.strokeStyle=this.canvas.clickColor[t],this.canvas.context.stroke())}erase(){for(var t=0;t<this.canvas.clickX.length;t++)this.canvas.context.globalCompositeOperation="destination-out",this.canvas.context.beginPath(),this.canvas.context.lineJoin="round",this.canvas.context.lineWidth=this.canvas.clickSize[t],this.canvas.clickDrag[t]&&t?this.canvas.context.moveTo(this.canvas.clickX[t-1],this.canvas.clickY[t-1]):this.canvas.context.moveTo(this.canvas.clickX[t]-1,this.canvas.clickY[t]),this.canvas.context.lineTo(this.canvas.clickX[t],this.canvas.clickY[t]),this.canvas.context.closePath(),this.canvas.context.stroke()}clearCanvas(){this.hasDrawings=!1,this.canvas.context.clearRect(0,0,this.canvas.element.width,this.canvas.element.height)}adjustCanvas(){this.canvas.hasOwnProperty("element")&&(this.canvas.element.width=document.body.offsetWidth,this.canvas.element.height=document.documentElement.scrollHeight)}restoreCanvas(t){var e=document.createElement("img");e.style.width=this.canvas.element.width+"px",e.style.height=this.canvas.element.height+"px",e.onload=function(){this.canvas.context.clearAll(),this.canvas.context.drawImage(e,0,0,this.canvas.element.width,this.canvas.element.height)}.bind(this),e.src=t}}document.addEventListener("DOMContentLoaded",function(){(webPageCanvas=new WebPageCanvas).init()},{once:!0}),chrome.runtime.onMessage.addListener(function(t,e,a){return null!=t&&t.hasOwnProperty("message")&&!t.hasOwnProperty("data")?"close-canvas"==t.message?webPageCanvas.hasDrawings?a({data:webPageCanvas.canvas.element.toDataURL()}):a(null):"save-canvas"==t.message?document.getElementById("toolbar").classList.add("hidden"):"resize-canvas"==t.message&&webPageCanvas.adjustCanvas():null!=t&&t.hasOwnProperty("message")&&t.hasOwnProperty("data")&&"restore-canvas"==t.message&&webPageCanvas.restoreCanvas(t.data),!0}),window.onmessage=function(t){"reset-toolbar"==t.data?document.getElementById("toolbar").classList.remove("hidden"):"object"==typeof t.data&&t.data.hasOwnProperty("message")&&"set-window-height"==t.data.message?0!=webPageCanvas.windowHeight&&document.getElementById("toolbar").classList.contains("aligned-bottom")?(webPageCanvas.windowHeight=t.data.data,webPageCanvas.alignClickHandler.call(webPageCanvas,document.querySelector("#toolbar-alignment .dropdown-item.bottom"))):webPageCanvas.windowHeight=t.data.data:"object"==typeof t.data&&t.data.hasOwnProperty("message")&&"set-window-scroll"==t.data.message&&(0!=webPageCanvas.windowScroll?(webPageCanvas.windowScroll=t.data.data,document.getElementById("toolbar").classList.contains("aligned-top")?webPageCanvas.alignClickHandler.call(webPageCanvas,document.querySelector("#toolbar-alignment .dropdown-item.top")):document.getElementById("toolbar").classList.contains("aligned-bottom")&&webPageCanvas.alignClickHandler.call(webPageCanvas,document.querySelector("#toolbar-alignment .dropdown-item.bottom"))):webPageCanvas.windowScroll=t.data.data)},window.onkeydown=function(t){27==t.keyCode&&webPageCanvas.destroy()};