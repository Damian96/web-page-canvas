var tabID,canvasFrame=document.createElement("iframe"),canvasImages=[],imagesLoaded=0,snapshots={},finalCanvas={element:document.createElement("CANVAS")};finalCanvas.context=finalCanvas.element.getContext("2d");var resetFinalCanvas=function(){finalCanvas.element=document.createElement("CANVAS"),finalCanvas.context=finalCanvas.element.getContext("2d")},getMaxHeight=function(){return Math.max(window.innerHeight,document.body.offsetHeight,document.body.scrollHeight,document.body.clientHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight)},getMaxWidth=function(){return Math.max(window.innerWidth,document.body.offsetWidth,document.body.scrollLeft)},scrollToTop=function(e){setTimeout(function(){window.scrollTo(0,0)},e)},insertCanvas=function(){canvasFrame.width=getMaxWidth(),canvasFrame.height=getMaxHeight(),canvasFrame.style.cssText="position: absolute; z-index: 123400000; top: 0; left: 0; min-width: 100%; min-height: 100%;",document.body.style.overflowX="hidden",canvasFrame.onload=window.onresize=function(){canvasFrame.contentWindow.postMessage({message:"set-window-height",data:window.innerHeight},canvasFrame.src)},window.onscroll=function(){canvasFrame.contentWindow.postMessage({message:"set-window-scroll",data:window.scrollY},canvasFrame.src)},canvasFrame.src=chrome.runtime.getURL("/web-resources/html/web-page-canvas.html"),document.body.appendChild(canvasFrame)},saveCanvas=function(){return resetFinalCanvas(),window.scrollTo(0,0),new Promise((e,n)=>{chrome.runtime.sendMessage({message:"take-snapshot",data:{windowHeight:window.innerHeight,pageHeight:getMaxHeight()}},function(a){null!=a&&a.hasOwnProperty("data")?a.hasOwnProperty("error")?n(a.error):e(a.data):n()})})},loadImages=function(e){return canvasImages=[],imagesLoaded=0,new Promise(n=>{e=e;for(let a of e){let t=new Image;finalCanvas.element.width=getMaxWidth(),finalCanvas.element.height=getMaxHeight(),t.dataset.x=a.x,t.dataset.y=a.y,t.onload=function(a){finalCanvas.context.drawImage(a,parseInt(a.dataset.x),parseInt(a.dataset.y)),++imagesLoaded==e.length&&n(finalCanvas.element.toDataURL("image/png"))}.bind(null,t),t.src=a.src,canvasImages.push(t)}})};chrome.runtime.onMessage.addListener(function(e,n,a){return null!=e&&e.hasOwnProperty("message")&&("close-canvas"==e.message?canvasFrame.remove():"save-canvas"==e.message?(scrollToTop(0),saveCanvas().then(function(e){"object"==typeof e&&loadImages(e).then(function(e){canvasFrame.contentWindow.postMessage("reset-toolbar",canvasFrame.src),a({message:"saved",data:e})}),scrollToTop(1e3)}).catch(function(e){scrollToTop(1e3)})):"scroll-top"==e.message&&(window.scrollTo(0,window.scrollY+window.innerHeight),a({message:"Scrolled"}))),!0}),insertCanvas();