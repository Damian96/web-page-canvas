var tabID,canvasFrame=document.createElement("iframe"),canvasImages=[],imagesLoaded=0,snapshots={},finalCanvas={element:document.createElement("CANVAS")};finalCanvas.context=finalCanvas.element.getContext("2d");var resetFinalCanvas=function(){finalCanvas.element=document.createElement("CANVAS"),finalCanvas.context=finalCanvas.element.getContext("2d")},getMaxHeight=function(){return Math.max(window.innerHeight,document.body.offsetHeight,document.body.scrollHeight,document.body.clientHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight)},getMaxWidth=function(){return Math.max(window.innerWidth,document.body.offsetWidth,document.body.scrollLeft)},scrollToTop=function(e){setTimeout(function(){window.scrollTo(0,0)},e)},insertCanvas=function(){canvasFrame.width=getMaxWidth(),canvasFrame.height=getMaxHeight(),canvasFrame.style.cssText="position: absolute; z-index: 123400000; top: 0; left: 0; min-width: 100%; min-height: 100%;",document.body.style.overflowX="hidden",canvasFrame.onload=window.onresize=function(){canvasFrame.contentWindow.postMessage({message:"set-window-height",data:window.innerHeight},canvasFrame.src)},canvasFrame.src=chrome.runtime.getURL("/web-resources/html/web-page-canvas.html"),document.body.appendChild(canvasFrame)},saveCanvas=function(){return resetFinalCanvas(),window.scrollTo(0,0),new Promise((e,a)=>{chrome.runtime.sendMessage({message:"take-snapshot",data:{windowHeight:window.innerHeight,pageHeight:getMaxHeight()}},function(n){null!=n&&n.hasOwnProperty("data")?n.hasOwnProperty("error")?a(n.error):e(n.data):a()})})},loadImages=function(e){return canvasImages=[],imagesLoaded=0,new Promise(a=>{e=e;for(let n of e){let t=new Image;finalCanvas.element.width=getMaxWidth(),finalCanvas.element.height=getMaxHeight(),t.dataset.x=n.x,t.dataset.y=n.y,t.onload=function(n){finalCanvas.context.drawImage(n,parseInt(n.dataset.x),parseInt(n.dataset.y)),++imagesLoaded==e.length&&a(finalCanvas.element.toDataURL("image/png"))}.bind(null,t),t.src=n.src,canvasImages.push(t)}})};chrome.runtime.onMessage.addListener(function(e,a,n){return null!=e&&e.hasOwnProperty("message")&&("close-canvas"==e.message?canvasFrame.remove():"save-canvas"==e.message?(scrollToTop(0),saveCanvas().then(function(e){"object"==typeof e&&loadImages(e).then(function(e){canvasFrame.contentWindow.postMessage("reset-toolbar",canvasFrame.src),n({message:"saved",data:e})}),scrollToTop(1e3)}).catch(function(e){scrollToTop(1e3)})):"scroll-top"==e.message&&(window.scrollTo(0,window.scrollY+window.innerHeight),n({message:"Scrolled"}))),!0}),insertCanvas();