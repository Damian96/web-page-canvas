var captureObjects=[],removeCaptureObject=function(t){null!=t&&captureObjects.includes(t)&&(captureObjects[t]=null)};class CaptureAPI{constructor(t,s,a){this.tabID=t,this.windowHeight=s,this.pageHeight=a,this.maxSnapshots=0,this.snapshots=[],this.snapshotInterval=1e3}init(){this.maxSnapshots=this.calcMaxSnapshots()}calcMaxSnapshots(){var t=Math.floor(this.pageHeight/this.windowHeight),s=this.pageHeight%this.windowHeight;return this.windowHeight>s&&(t+=s/this.windowHeight),t}takeSnapshot(t,s,a){return new Promise((e,n)=>{var i=this.maxSnapshots-this.snapshots.length;this.maxSnapshots,this.snapshots.length;"function"!=typeof t&&n("invalid takeSnapshot parameters given!"),(this.maxSnapshots>20||this.pageHeight>4e3)&&n("too tall page to take snapshot"),i>0?setTimeout(function(){chrome.tabs.captureVisibleTab({format:"jpeg"},function(t,s,a,e){this.snapshots.push(e),chrome.tabs.sendMessage(this.tabID,{message:"scroll-top"},function(t,s,a,e){"Scrolled"===e.message&&(chrome.runtime.sendMessage({message:"update-snapshot-process",data:100*this.snapshots.length/this.maxSnapshots}),this.takeSnapshot.call(this,t,s,a))}.bind(this,t,s,a))}.bind(this,t,s,a))}.bind(this,t,s,a),this.snapshotInterval):e(t.call(s,a,this.snapshots))})}}chrome.runtime.onMessage.addListener(function(t,s,a){if(console.log(t),"take-snapshot"===t.message&&null!=t.data&&null!=s.tab.id&&null!=t.data.windowHeight&&null!=t.data.pageHeight)return captureObjects[s.tab.id]=new CaptureAPI(s.tab.id,t.data.windowHeight,t.data.pageHeight),captureObjects[s.tab.id].init(),captureObjects[s.tab.id].takeSnapshot(function(t,a){for(var e=[],n=captureObjects[s.tab.id],i=0;i<a.length;i++){var h=0,o=a.length-1;i<o||i==o&&n.maxSnapshots%1==0?h=i*n.windowHeight:i==o&&n.maxSnapshots%1!=0&&(h=i*n.windowHeight,h-=n.windowHeight-n.maxSnapshots%1*n.windowHeight),e.push({src:a[i],x:0,y:h})}return t({data:e}),!0},null,a).then(function(t){}).catch(function(t){a({data:null,error:t})}),!0}),chrome.tabs.onUpdated.addListener(function(t){removeCaptureObject(t)}),chrome.tabs.onRemoved.addListener(function(t){removeCaptureObject(t)});