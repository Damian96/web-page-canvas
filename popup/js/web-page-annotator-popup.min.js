var webPageAnnotator,background=chrome.extension.getBackgroundPage();class WebPageAnnotatorPopup{constructor(){this.overlayOpen=!1,this.toolsOptions={paintBrush:{color:"#FFFF00",defaultColor:"#FFFF00",size:5},eraser:{size:5}},this.activeTool={id:"paintBrush",htmlId:"paint-brush",options:this.toolsOptions.paintBrush},this.activePanel={id:"none",htmlId:"none"},this.localSnapshots=[],this.isProperPage=!0,this.STORAGEAREAKEY="webPageAnnotator_screenshots_array"}init(){this.attachHandlers(),this.tabClickHandler.call(this,document.querySelector(".tab-title[data-tool-id='paint-brush']")),this.isProperPage||(document.querySelector("#switcher button.on").disabled=!0)}reload(attributes){for(let key in attributes)this[key]=attributes[key];this.attachHandlers(),this.reloadValues()}reloadValues(){let switcher=document.getElementById("switcher"),dataSelector="[data-tool-id='"+this.activeTool.htmlId+"']";if("library"==this.activePanel.id?this.tabClickHandler.call(this,document.querySelector(".tab-title.panel[data-panel-id='library']")):this.tabClickHandler.call(this,document.querySelector(".tab-title"+dataSelector)),this.overlayOpen?(switcher.classList.remove("off"),switcher.classList.add("on"),document.getElementById("save").disabled=!1):(switcher.classList.remove("on"),switcher.classList.add("off"),document.getElementById("save").disabled=!0),"paintBrush"==this.activeTool.id&&"none"==this.activePanel.id){let colorElement=document.querySelector(".tab-content"+dataSelector+" .color[data-color-code='"+this.toolsOptions.paintBrush.color+"']"),sizeElement=document.querySelector(".tab-content"+dataSelector+" .size-range");sizeElement.value=this.toolsOptions.paintBrush.size,this.colorClickHandler(colorElement),this.sizeHandler(sizeElement)}else if("eraser"==this.activeTool.id){document.querySelector(".tab-content"+dataSelector+" .size-range").value=this.toolsOptions.eraser.size}}reloadSlideshow(){let slideshow=document.getElementById("slideshow"),slideImage=document.getElementById("slide-image"),currentScreenshotNumber=document.getElementById("current-screenshot-number"),totalScreenshotNumber=document.getElementById("total-screenshot-number");this.localSnapshots.length>0?(slideshow.className="",slideImage.src=this.b64ToBlobURL(this.localSnapshots[this.localSnapshots.length-1]),slideImage.dataset.storageIndex=this.localSnapshots.length-1,currentScreenshotNumber.innerText=this.localSnapshots.length-1==0?1:this.localSnapshots.length,totalScreenshotNumber.innerText=this.localSnapshots.length):chrome.storage.local.get(this.STORAGEAREAKEY,function(items){"object"==typeof items[this.STORAGEAREAKEY]&&items[this.STORAGEAREAKEY].length>0&&(this.localSnapshots=items[this.STORAGEAREAKEY],slideshow.className="",slideImage.src=this.b64ToBlobURL(this.localSnapshots[this.localSnapshots.length-1]),slideImage.dataset.storageIndex=this.localSnapshots.length-1,currentScreenshotNumber.innerText=this.localSnapshots.length-1==0?1:this.localSnapshots.length,totalScreenshotNumber.innerText=this.localSnapshots.length)}.bind(this))}attachHandlers(){let switcher=document.getElementById("switcher");document.getElementById("save").addEventListener("click",this.saveClickHandler.bind(this)),switcher.addEventListener("click",this.switcherClickHandler.bind(this,switcher));for(let element of document.querySelectorAll(".tab-title"))element.addEventListener("click",this.tabClickHandler.bind(this,element));for(let element of document.querySelectorAll(".tab-content .color"))element.addEventListener("click",this.colorClickHandler.bind(this,element));for(let element of document.querySelectorAll(".tab-content input.size-range"))element.addEventListener("change",this.sizeHandler.bind(this,element));for(let element of document.querySelectorAll("#slideshow > .screenshot-actions > div"))element.addEventListener("click",this.screenshotActionClickHandler.bind(this,element));for(let element of document.querySelectorAll("#slideshow > .screenshot-navigation > i"))element.addEventListener("click",this.screenshotNavigationClickHandler.bind(this,element))}switcherClickHandler(element,sendMessageToTab=!0){element.classList.contains("off")?(this.overlayOpen=!0,chrome.tabs.sendMessage(this.tabID,{message:"init-canvas",data:{tool:this.activeTool,tabID:this.tabID}}),element.classList.remove("off"),element.classList.add("on"),document.getElementById("save").disabled=!1):element.classList.contains("on")&&(this.overlayOpen=!1,sendMessageToTab&&chrome.tabs.sendMessage(this.tabID,{message:"close-canvas"}),element.classList.remove("on"),element.classList.add("off"),document.getElementById("save").disabled=!0)}screenshotActionClickHandler(element){let slideshow=document.getElementById("slideshow"),slideImage=document.getElementById("slide-image");""==slideshow.className&&null!=slideImage.src&&(element.classList.contains("save-screenshot")?chrome.tabs.sendMessage(this.tabID,{message:"insert-snapshot-download",data:slideImage.src}):element.classList.contains("delete-screenshot")&&chrome.storage.local.get(this.STORAGEAREAKEY,function(slideImage,slideshow,items){let data=items[this.STORAGEAREAKEY],currentScreenshotNumber=document.getElementById("current-screenshot-number"),totalScreenshotNumber=document.getElementById("total-screenshot-number");"object"==typeof data&&data.length>0&&(data.splice(slideImage.dataset.storageIndex,1),data.length>0?(slideImage.src=this.b64ToBlobURL(data[data.length-1]),slideImage.dataset.storageIndex=data.length-1,currentScreenshotNumber.innerText=data.length-1==0?1:data.length,totalScreenshotNumber.innerText=data.length):(slideshow.className="empty",slideImage.src="",slideImage.dataset.storageIndex="-1"),this.localSnapshots=data,chrome.storage.local.set({[this.STORAGEAREAKEY]:data}))}.bind(this,slideImage,slideshow)))}screenshotNavigationClickHandler(element){let newImageIndex,currentImageIndex=parseInt(document.getElementById("slide-image").dataset.storageIndex),slideImage=document.getElementById("slide-image"),currentScreenshotNumber=document.getElementById("current-screenshot-number");newImageIndex="Previous"==element.title?currentImageIndex-1<0?this.localSnapshots.length-1:currentImageIndex-1:currentImageIndex+1>=this.localSnapshots.length?0:currentImageIndex+1,slideImage.dataset.storageIndex=newImageIndex,currentScreenshotNumber.innerText=newImageIndex+1,slideImage.src=this.b64ToBlobURL(this.localSnapshots[newImageIndex])}saveClickHandler(){this.tabClickHandler.call(this,document.querySelector(".tab-title[data-panel-id='library'")),chrome.tabs.sendMessage(this.tabID,{message:"save-canvas"},function(response){console.log(response),response.hasOwnProperty("message")&&response.hasOwnProperty("data")&&"saved"==response.message&&(console.log("ok response"),this.insertImage(response.data).then(function(){console.log("image inserted"),this.reloadSlideshow()}.bind(this)))}.bind(this))}tabClickHandler(element){if(!element.classList.contains("active"))if(this.disableAllTabs(),element.classList.add("active"),element.dataset.toolId){let id=element.dataset.toolId;document.querySelector(".tab-content[data-tool-id='"+id+"']").classList.add("active"),this.activePanel.id="none",this.activePanel.htmlId="none",this.changeActiveTool(id)}else{let id=element.dataset.panelId;document.querySelector(".tab-content[data-panel-id='"+id+"']").classList.add("active"),"library"==id&&this.reloadSlideshow(),this.activePanel.id=id,this.activePanel.htmlId=id,this.activeTool.id="paintBrush",this.activeTool.htmlId="paint-brush"}}changeActiveTool(newId){let id=this.changeToCamelCase(newId);this.activeTool={id:id,htmlId:"paintBrush"===id?"paint-brush":id,options:this.toolsOptions[id]},this.updatePageActiveTool()}updatePageActiveTool(){chrome.tabs.sendMessage(this.tabID,{message:"update-info",data:{tool:this.activeTool,tabID:this.tabID}})}colorClickHandler(element){if(!element.classList.contains("active")){let tabContent=element.parentElement.parentElement,toolId=tabContent.dataset.toolId,colorName=element.title.toLowerCase();this.disableAllColors(toolId),element.classList.add("active"),"paint-brush"===toolId&&(this.toolsOptions.paintBrush.color=element.dataset.colorCode),tabContent.dataset.toolColor=colorName,document.querySelector(".tab-title[data-tool-id='"+toolId+"']").dataset.toolColor=colorName,this.changeActiveTool(toolId)}}sizeHandler(element){let toolId=element.dataset.toolId,value=parseFloat(element.value);element.nextElementSibling.innerHTML=value+"px","paint-brush"===toolId?this.toolsOptions.paintBrush.size=value:"eraser"===toolId&&(this.toolsOptions.eraser.size=value),this.changeActiveTool(toolId)}disableAllTabs(){for(let element of document.querySelectorAll(".tab-title.active, .tab-content.active"))element.classList.remove("active")}disableAllColors(toolId){let contentSelector=".tab-content[data-tool-id='"+toolId+"']";for(let element of document.querySelectorAll(contentSelector+" .color.active"))element.classList.remove("active")}changeToCamelCase(string){if(string.includes("-")){let strParts=string.split("-");return strParts[0]+strParts[1].charAt(0).toUpperCase()+strParts[1].substr(1,strParts[1].length)}return string}animateLoader(targetW){let slideshow=document.getElementById("slideshow"),loader=document.getElementById("passed-bar"),percent=document.getElementById("loader-percent");slideshow.classList.contains("loading")||(slideshow.className="loading"),targetW>=100?(loader.style.width="100%",percent.innerHTML="100"):(loader.style.width=targetW+"%",percent.innerHTML=parseInt(targetW))}insertImage(newImageSrc){return console.log("insering image",typeof newImageSrc),new Promise(resolve=>{chrome.storage.local.get(this.STORAGEAREAKEY,function(newImageSrc,items){console.log(items.STORAGEAREAKEY),"object"==typeof items[this.STORAGEAREAKEY]?this.localSnapshots=items[this.STORAGEAREAKEY].concat([newImageSrc]):this.localSnapshots=new Array(newImageSrc),console.log(this.localSnapshots);let imageBlobURL=this.b64ToBlobURL(newImageSrc);chrome.storage.local.set({[this.STORAGEAREAKEY]:this.localSnapshots},function(imageBlobURL){let slideImage=document.getElementById("slide-image"),currentScreenshotNumber=document.getElementById("current-screenshot-number"),totalScreenshotNumber=document.getElementById("total-screenshot-number");slideImage.src=imageBlobURL,slideImage.dataset.storageIndex=this.localSnapshots.length-1,currentScreenshotNumber.innerText=this.localSnapshots.length-1==0?1:this.localSnapshots.length,totalScreenshotNumber.innerText=this.localSnapshots.length,resolve("success")}.bind(this,imageBlobURL))}.bind(this,newImageSrc))})}b64ToBlobURL(dataURL){let binary=atob(dataURL.split(",")[1]),array=[];for(var i=0;i<binary.length;i++)array.push(binary.charCodeAt(i));let blob=new Blob([new Uint8Array(array)],{type:"image/png"});return URL.createObjectURL(blob)}}webPageAnnotator=new WebPageAnnotatorPopup,window.onunload=function(){background.popupObjects[webPageAnnotator.tabID]=webPageAnnotator},window.onload=function(){chrome.tabs.getSelected(null,function(tab){webPageAnnotator.tabID=tab.id,(tab.url.includes("chrome://")||tab.url.includes("file:///"))&&(webPageAnnotator.isProperPage=!1),chrome.runtime.sendMessage({message:"init-object",tabID:webPageAnnotator.tabID},function(response){response.hasOwnProperty("message")&&("do-it-yourself"==response.message?webPageAnnotator.init():"sending-popup-object-data"==response.message&&response.hasOwnProperty("data")&&webPageAnnotator.reload(response.data))})}),webPageAnnotator.reloadSlideshow()},chrome.runtime.onMessage.addListener(function(request){request.hasOwnProperty("message")&&request.hasOwnProperty("data")&&"update-snapshot-process"==request.message&&webPageAnnotator.animateLoader(request.data)});